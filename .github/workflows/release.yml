name: ğŸ·ï¸ Auto Release
run-name: ${{ github.actor }} is creating a release ğŸ‰

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-alpha*'
      - 'v*.*.*-beta*'
      - 'v*.*.*-rc*'

jobs:
  create-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: self-hosted
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ Get tag info
      id: tag_info
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=${TAG#v}" >> $GITHUB_OUTPUT
        
        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
        if [[ $TAG == *"alpha"* ]]; then
          echo "prerelease=true" >> $GITHUB_OUTPUT
          echo "release_type=Alpha" >> $GITHUB_OUTPUT
        elif [[ $TAG == *"beta"* ]]; then
          echo "prerelease=true" >> $GITHUB_OUTPUT
          echo "release_type=Beta" >> $GITHUB_OUTPUT
        elif [[ $TAG == *"rc"* ]]; then
          echo "prerelease=true" >> $GITHUB_OUTPUT
          echo "release_type=Release Candidate" >> $GITHUB_OUTPUT
        else
          echo "prerelease=false" >> $GITHUB_OUTPUT
          echo "release_type=Stable" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“ Generate changelog
      id: changelog
      run: |
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ñ‚ĞµĞ³
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "changelog=Initial release of TensorAeroSpace ğŸš€" >> $GITHUB_OUTPUT
        else
          # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ changelog Ğ¼ĞµĞ¶Ğ´Ñƒ Ñ‚ĞµĞ³Ğ°Ğ¼Ğ¸
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD --no-merges)
          
          # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ changelog
          cat << EOF >> changelog.md
        ## ğŸš€ What's New in ${{ steps.tag_info.outputs.version }}
        
        ### ğŸ“‹ Changes
        $CHANGELOG
        
        ### ğŸ”§ Installation
        \`\`\`bash
        pip install tensoraerospace==${{ steps.tag_info.outputs.version }}
        \`\`\`
        
        ### ğŸ“š Documentation
        - [ğŸ“– Full Documentation](https://tensoraerospace.readthedocs.io/)
        - [ğŸ¯ Examples](https://github.com/tensoraerospace/tensoraerospace/tree/main/example)
        - [ğŸ¤ Contributing Guide](https://github.com/tensoraerospace/tensoraerospace/blob/main/CONTRIBUTING.md)
        
        ---
        
        **Full Changelog**: https://github.com/tensoraerospace/tensoraerospace/compare/$PREVIOUS_TAG...${{ steps.tag_info.outputs.tag }}
        EOF
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ­ Install Poetry
      run: |
        python -m pip install --upgrade pip
        pip install poetry

    - name: ğŸ“š Install dependencies
      run: |
        poetry install

    - name: ğŸ—ï¸ Build package
      run: |
        poetry build

    - name: ğŸ‰ Create Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag_info.outputs.tag }}
        release_name: "ğŸš€ TensorAeroSpace ${{ steps.tag_info.outputs.version }} (${{ steps.tag_info.outputs.release_type }})"
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: ${{ steps.tag_info.outputs.prerelease }}

    - name: ğŸ“¦ Upload wheel to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/*.whl
        asset_name: tensoraerospace-${{ steps.tag_info.outputs.version }}-py3-none-any.whl
        asset_content_type: application/zip
      continue-on-error: true

    - name: ğŸ“¦ Upload source distribution to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/*.tar.gz
        asset_name: tensoraerospace-${{ steps.tag_info.outputs.version }}.tar.gz
        asset_content_type: application/gzip
      continue-on-error: true

  notify:
    name: ğŸ“¢ Notify Release
    runs-on: self-hosted
    needs: create-release
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify success
      if: needs.create-release.result == 'success'
      run: |
        echo "âœ… Release created successfully!"
        echo "ğŸ‰ TensorAeroSpace ${{ needs.create-release.outputs.version }} is now available!"
        
    - name: âŒ Notify failure
      if: needs.create-release.result == 'failure'
      run: |
        echo "âŒ Release creation failed!"
        exit 1