name: âš¡ Quick Check
run-name: ${{ github.actor }} is running quick checks ğŸ”

on:
  push:
    branches:
      - '**'  # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ½Ğ° Ğ²ÑĞµÑ… Ğ²ĞµÑ‚ĞºĞ°Ñ…
  pull_request:
    branches:
      - '**'  # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ´Ğ»Ñ PR Ğ² Ğ»ÑĞ±Ñ‹Ğµ Ğ²ĞµÑ‚ĞºĞ¸

jobs:
  quick-test:
    name: âš¡ Quick Test (Python 3.10, Ubuntu)
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Cache Poetry dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pypoetry
          ~/.cache/pip
        key: ubuntu-latest-poetry-3.10-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          ubuntu-latest-poetry-3.10-

    - name: ğŸ­ Install Poetry
      run: |
        pip install --upgrade pip
        pip install poetry

    - name: âš™ï¸ Configure Poetry
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true

    - name: ğŸ”„ Check and update lock file if needed
      run: |
        if ! poetry check --lock; then
          echo "Lock file is outdated, updating..."
          poetry lock --no-update
        fi

    - name: ğŸ“š Install dependencies
      run: |
        poetry install --only main,test

    - name: ğŸ” Quick lint check
      run: |
        poetry run python -m py_compile tensoraerospace/**/*.py

    - name: ğŸ§ª Run core tests only
      run: |
        poetry run pytest tests/envs/ -v --tb=short -x --maxfail=3

    - name: âœ… Quick import test
      run: |
        poetry run python -c "import tensoraerospace; print('âœ… Import successful')"

  code-quality:
    name: ğŸ“ Code Quality Check
    runs-on: self-hosted
    timeout-minutes: 5

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ­ Install Poetry
      run: |
        pip install --upgrade pip
        pip install poetry

    - name: ğŸ”„ Check and update lock file if needed
      run: |
        if ! poetry check --lock; then
          echo "Lock file is outdated, updating..."
          poetry lock --no-update
        fi

    - name: ğŸ“š Install dependencies
      run: |
        poetry install --with dev

    - name: ğŸ” Check code formatting with black
      run: |
        poetry run black --check --diff tensoraerospace/

    - name: ğŸ“ Check import sorting with isort
      run: |
        poetry run isort --check-only --diff tensoraerospace/

    - name: ğŸ” Basic flake8 check
      run: |
        poetry run flake8 tensoraerospace --count --select=E9,F63,F7,F82 --show-source --statistics

  dependency-check:
    name: ğŸ”’ Dependency Security Check
    runs-on: self-hosted
    timeout-minutes: 5

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ­ Install Poetry
      run: |
        pip install --upgrade pip
        pip install poetry

    - name: ğŸ”„ Check and update lock file if needed
      run: |
        if ! poetry check --lock; then
          echo "Lock file is outdated, updating..."
          poetry lock --no-update
        fi

    - name: ğŸ“š Install dependencies
      run: |
        poetry install --with dev

    - name: ğŸ” Check for known security vulnerabilities
      run: |
        poetry run safety check || echo "âš ï¸ Security vulnerabilities found, but not failing the build"

    - name: ğŸ“‹ Show dependency tree
      run: |
        poetry show --tree